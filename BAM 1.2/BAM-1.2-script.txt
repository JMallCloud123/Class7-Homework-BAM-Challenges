#!/bin/bash
# This line above tells the system to use the bash shell to run this script
# The "#!" is called a "shebang" - it's like saying "use this program to run what follows"
##
cloud-init clean

####################################################################
# This section installs the needed software and sets it up
####################################################################

# Install and configure a web server (Apache HTTP Server)
# The "dnf" command is Amazon Linux's package manager 

# Update all installed software to the latest versions
# The "-y" means "automatically say yes to any prompts"
dnf update -y

# Install Apache web server software (called "httpd" on Linux)
dnf install -y httpd

# Start the web server service (make it begin running)
systemctl start httpd

# Enable the web server to automatically start when the computer reboots
systemctl enable httpd

####################################################################
# Here you can change the picture and text if you want
####################################################################

# Set the image URL as a variable to make it easy to change later
# You can modify this URL to use any image you want on your webpage
IMAGE="https://www.w3schools.com/images/w3schools_green.jpg"
TEXT="My EC2 Instance"

####################################################################
# Here we get the metadata for the EC2 instance
####################################################################

# Get AWS metadata about this EC2 instance
# AWS provides a special internal web address that only works from inside EC2 instances
# This address (169.254.169.254) gives you information about the current instance

# Base URL and header variables for metadata service
BASE_URL="http://169.254.169.254/latest"
HEADERS="X-aws-ec2-metadata-token"

# Get a "session token" first 
# This token acts like a temporary password that expires after 1 hour (3600 seconds)
# The $(...) syntax captures the output of the command inside and stores it in the TOKEN variable
# curl is a command-line tool for using web protocols (like downloading things)
# -X PUT specifies the type of web request (we need PUT to generate the session token)
# -H adds a header to the request
TOKEN=$(curl -X PUT "$BASE_URL/api/token" -H "$HEADERS-ttl-seconds: 3600" -s)

# Get metadata directly into variables
# The "-s" flag makes curl run silently (without showing progress information)
LOCAL_IP=$(curl -H "$HEADERS: $TOKEN" -s "$BASE_URL/meta-data/local-ipv4")
AZ=$(curl -H "$HEADERS: $TOKEN" -s "$BASE_URL/meta-data/placement/availability-zone")
MAC_ID=$(curl -H "$HEADERS: $TOKEN" -s "$BASE_URL/meta-data/network/interfaces/macs/")

# Use the MAC address to get the VPC (Virtual Private Cloud) ID
# This requires the MAC address from the previous step
VPC_ID=$(curl -H "$HEADERS: $TOKEN" -s "$BASE_URL/meta-data/network/interfaces/macs/${MAC_ID}/vpc-id")

# Get instance name from tags
HOST_NAME=$(hostname -f)

####################################################################
# Here we create an HTML web page with the collected information
####################################################################

# Using a "heredoc" (here document) - a cleaner way to write multi-line text
# "cat << EOF" means "output everything until you see 'EOF' on its own line"
# This is easier to read than using echo with quotes, especially for HTML
cat << EOF > /var/www/html/index.html
<!DOCTYPE html>
<html>
<head>
    <title>EC2 Instance Info</title>

    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        h1 { color: #232f3e; }
        p { margin: 10px 0; }
        img { max-width: 300px; margin: 20px 0; }
    </style>

</head>
<body>
    <h2>"I, Jay Mallard, Thank Theo And Class 7, For Teaching Me About Ec2s In Aws. One Step Closer To Escaping Keisha! With This Class, I Will Net 140k Per Year!"</h2>

    <!-- Insert an image or GIF -->
    <img src="https://d19r6u3d126ojb.cloudfront.net/The_Most_Expensive_Yachts_in_the_world_6298827081.webp" alt="Instance Image">

    <h2>"I found my wives on a party yacht in Brasil and Thailand! Their names are Thais and Naniporn!"</h2>

    <br><br>
    <img src="https://hw1s3brasilthailand.s3.us-east-2.amazonaws.com/Screenshot%202025-09-21%20202146.jpg?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAWYBEBKV4A56JY7BD%2F20250922%2Fus-east-2%2Fs3%2Faws4_request&X-Amz-Date=20250922T004620Z&X-Amz-Expires=300&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJn%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMiJHMEUCIDpvuczBEUJyIxiPFbVeEGmwBcYRcz%2FPuPdY8ZMmt%2FjzAiEAgT0%2B%2F%2F0UGl0Gvz5fSRD5x0ho2hphHujA6YjDbQKXCN0q7QIIIhAAGgw0NjM5MzIwNTI4NTYiDLsc6GcbMlfkXc56TirKAgS%2BT%2B6SM%2Bk1z5uTarvp%2FZNaLvstZ89JJ%2B94SyWn9g0IDm1dYcj8PsvQni%2FoAH5yTU3LCvsJCS9BsRDRxv7ATWJIeb%2FWMH12VD4A0ycGGCgNs33FTKd3WLa2XYUguxrHAZ8k0SEK0fD9V2fFBYjjbNDzl8Y7nLmuweRjuBWye0449IYAk3Z0uMe0%2F%2Fp7xzgEqHvqkksuzJlP0NfJrZ%2B%2BYqIyZPMX7Ft4H%2Bm0%2BYyMpeeXsDPbPKRBQS3dv0nCebHcHIBPP%2BY7g53K%2FSKxjhyzvND33N5DFudvll04g3jPXyqUTZJyZz1z%2FdFwuAkcyjlh3PzDmwj%2F8Ocm1JTCd1U5zVG5hLCfDe3oCjOH%2FRNwtrJLVbnSvHV0d5kdFkBr7XDtHe%2F6EIQNJv0doZugAEmRw7R%2FNKxrkm0lnyv8OK6kSPmxpctD1YaaQq9TADCPhMLGBjqtAuSA8gxC8LwEQm6cI82JLrbqHBcAvjzsCBENrDza%2FKkOgMxO0S3XB79G%2B121zKgXqKQztuCVEtISQRMK5ljjyvd%2B2Hx%2B1zodzFP8MFrebVO0RrqSWbp3hed4sG%2BCfqA2FRgkU2um2la6nQqTRsbPT6iizibAL9dy3qoNYhAiWfUSnpfL%2FM1rK%2F%2B8AyR287ic4P9bP7oWEcugPittlJB8RqrSM6b3ML3aNCSdjjrOw8La6DUW3v2UiLDHLBGVgurzHxmXWPd8IN%2B%2BZ0XxPZ60GABJt5zYH9oAcVhG2AvRCyuoLlGDXnFN0ce7JeavyYShpMt6hLQyIAGP88UvkufCX%2BYtFaT1U6zVTfjUbx0wBq8HWIOzFBUGYFSBaipUzPqBFgWyuD9XO%2BNF0IZWSQ4%3D&X-Amz-Signature=b6fd3c496c6505f71440747b92bf604cefd4a12aaa393113f334a452365161ab&X-Amz-SignedHeaders=host&response-content-disposition=inline" width="400">
    <img src="https://hw1s3brasilthailand.s3.us-east-2.amazonaws.com/Screenshot%202025-09-21%20202155.jpg?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAWYBEBKV4EUVQ54TM%2F20250922%2Fus-east-2%2Fs3%2Faws4_request&X-Amz-Date=20250922T004700Z&X-Amz-Expires=300&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJn%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMiJHMEUCIHugR5WeJ8Cc9Tvcl3cjEUkyFUPt%2FdAcT0EHIErm%2FYC8AiEAx7%2B1EIsyKq1MNOaYJ1qRfl2N4EbeGqyceYsPZcETGLoq7QIIIhAAGgw0NjM5MzIwNTI4NTYiDBMCapNtOzePY12kSyrKAng1Y%2FX6sTWbcBTvbgJGmSykFobpvJvp1eHJS0bZGtJwZRes0updNj4kzf8US6wdsbkL0lECQTwj6R1bJpm8gmRwuVSDQHrXdwELaqEsr%2B6jcJA5YllmhlbRXNeFNQyrn%2BRsmXCT9WZHSjY5%2BZIk5zBqrfT6CqteQ02Gt1re8l3nX5xlGcj6%2BjqqFb74o7d148xon2lX7W7yCap%2FEKwOFeU2QgDfXvgvtwOWUvzCNMYXOecuksb17O8wgLrmL%2BUhQ1R7kDIKPLXCQLPq9Mc8OcXv4VFL9qLiMGm52L%2BYNj5dr2pDs01v8rBzaocLk3Dg8vZo%2FMAWh5atcuEvX9OwT7sgv%2FTkZRFNpyEAARxE4f9wXTtpsShq5Oar5YExWy5BZnJpFHnb%2FIEyRFuYRvr6rgsqqs3pFdF6%2BW513bwTadJYcA%2BccdMSqu7rUTCPhMLGBjqtAp6U3JktxGgQzXO7YxJq8UuzT4q2L16SXxmyI3VzmvKjLC5e1cv9Q3S8np1j5eyMqtgMJ5edDZjWIaaG%2Bb1dVmIgaMwME1l7y8ivI%2FdUB19A3qIFnJcKlvR6RdJXWB3hB0pF4N8cFP%2BFUlS5Rd60d9a9YcM2LYI%2BQyfE%2FvpE2jnYXMz6t5DKuN49fZ8t%2B5jLs9HsggPrBwiKK2XyGSvK8CC77%2FqFvHsWfN4K7%2B49eHmAs89JtUA0QS4w%2BxzLhujrUfHjIZEY66W6wqOA7U05DEN6FoT684hyX0Qzqdd0L06ac8fja2dLS2TPk1LI9HaJtofF7ySCZ9LUHp4lf0t05JQ4paGePsxNsKomILWJf%2BZOPJEiDtrSnKC184iekcH1gUVllP5ooQHdnIaXRxg%3D&X-Amz-Signature=dda834e2532f0957ca86555bf64ced4302b494b2cb577d03cb161558c1e4190b&X-Amz-SignedHeaders=host&response-content-disposition=inline" width="400">


    <h2>Instance Details</h2>
    <p><strong>Hostname:</strong> ${HOST_NAME}</p>
    <p><strong>Private IP:</strong> ${LOCAL_IP}</p>
    <p><strong>Availability Zone:</strong> ${AZ}</p>
    <p><strong>VPC ID:</strong> ${VPC_ID}</p>
</body>
</html>
EOF

# The "> /var/www/html/index.html" redirects all that text into a file
# /var/www/html/ is the default folder where Apache web server looks for web pages
# index.html is the default file name web browsers request when visiting a website

####################################################################
# Summary
####################################################################

# This script installs a web server, collects information about the EC2 instance
# it's running on, creates a web page displaying that information, and displays a picture. 
# When complete, you can visit this instance's public IP address or DNS address
# in a web browser to see the information page.
# Remember to use HTTP://<your public DNS> since TLS is not configured.